<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plataforma de Comidas - Gestión de Locales</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .status-toggle { width: 300px; height: 120px; font-size: 2rem; }
    .card-img-top { height: 180px; object-fit: cover; }
    .category-section { margin-bottom: 3rem; }
  </style>
</head>
<body>
  <div class="container">

    <!-- ==================== SECCIÓN DE AUTENTICACIÓN ==================== -->
    <div id="auth-section" class="my-5">
      <h2>Acceso Local</h2>
      <button id="show-register" class="btn btn-secondary me-2">Registrar Local</button>
      <button id="show-login" class="btn btn-primary">Login Local</button>

      <form id="local-register-form" class="mt-3 d-none">
        <input type="text" id="reg-local-name" placeholder="Nombre del Local" class="form-control mb-2" required>
        <input type="email" id="reg-local-email" placeholder="Email" class="form-control mb-2" required>
        <input type="password" id="reg-local-password" placeholder="Contraseña" class="form-control mb-2" required>
        <button type="submit" class="btn btn-secondary">Confirmar Registro</button>
      </form>

      <form id="local-login-form" class="mt-3 d-none">
        <input type="email" id="login-local-email" placeholder="Email" class="form-control mb-2" required>
        <input type="password" id="login-local-password" placeholder="Contraseña" class="form-control mb-2" required>
        <button type="submit" class="btn btn-primary">Confirmar Login</button>
      </form>
      <div id="auth-status" class="mt-2"></div>
    </div>

    <!-- ==================== PANEL DEL LOCAL LOGUEADO ==================== -->
    <div id="local-dashboard" class="d-none">

      <div class="d-flex justify-content-between align-items-center my-4">
        <h1 class="mb-0">Gestión de Menús</h1>

        <!-- Toggle Estado del Local -->
        <div class="text-center me-5">
          <p class="mb-2 fw-bold">Estado del Local</p>
          <button id="status-toggle" class="btn status-toggle">
            <span id="status-text">CARGANDO...</span>
          </button>
        </div>

        <!-- Dropdown Mi Perfil -->
        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            Mi perfil
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" id="edit-profile">Editar perfil</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="#" id="logout">Cerrar sesión</a></li>
          </ul>
        </div>
      </div>

      <!-- Pestañas Mi Menú / Agregar Item -->
      <ul class="nav nav-tabs mb-4" id="menuTabs">
        <li class="nav-item">
          <a class="nav-link active" id="tab-mimenu" href="#">Mi Menú</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="tab-agregar" href="#">Agregar Item</a>
        </li>
      </ul>

      <!-- Contenido de Mi Menú -->
      <div id="mimenu-content">
        <div id="menu-items-container">
          <!-- Aquí se cargarán las tarjetas agrupadas por categoría -->
        </div>
      </div>

      <!-- Formulario Agregar Item (oculto inicialmente) -->
      <form id="menu-form" class="mb-4 d-none">
        <div class="mb-3">
          <label for="nombre" class="form-label">Nombre del Ítem</label>
          <input type="text" class="form-control" id="nombre" required>
        </div>
        <div class="mb-3">
          <label for="categoria" class="form-label">Categoría</label>
          <input type="text" class="form-control" id="categoria" required>
        </div>
        <div class="mb-3">
          <label for="descripcion" class="form-label">Descripción</label>
          <textarea class="form-control" id="descripcion" required></textarea>
        </div>
        <div class="mb-3">
          <label for="precio" class="form-label">Precio</label>
          <input type="number" class="form-control" id="precio" step="0.01" required>
        </div>
        <div class="mb-3">
          <label for="disponibilidad" class="form-label">Disponibilidad</label>
          <select class="form-control" id="disponibilidad" required>
            <option value="Sí">Sí</option>
            <option value="No">No</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="tamano_porcion" class="form-label">Tamaño/Porción</label>
          <input type="text" class="form-control" id="tamano_porcion" required>
        </div>
        <div class="mb-3">
          <label for="variantes" class="form-label">Variantes/Opciones</label>
          <input type="text" class="form-control" id="variantes" required>
        </div>
        <div class="mb-3">
          <label for="tiempo_preparacion" class="form-label">Tiempo de Preparación (min)</label>
          <input type="number" class="form-control" id="tiempo_preparacion" required>
        </div>
        <div class="mb-3">
          <label for="foto" class="form-label">Foto del Ítem</label>
          <input type="file" class="form-control" id="foto" accept="image/*" required>
        </div>
        <button type="submit" class="btn btn-primary">Agregar Ítem</button>
      </form>

      <div id="status" class="mt-3"></div>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxMjHVmcLEazSyDYA-xPnuuLzOcK6ejTojKLdLGuUzuRgSh2JYqOSUvryqd7fwwzjpG/exec';
    const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dw10wkbac/image/upload';
    const CLOUDINARY_UPLOAD_PRESET = 'ml_default';

    let localToken = localStorage.getItem('localToken');

    // ==================== FUNCIÓN PARA MOSTRAR EL DASHBOARD ====================
    function showDashboard() {
      document.getElementById('auth-section').classList.add('d-none');
      document.getElementById('local-dashboard').classList.remove('d-none');
      loadLocalStatus();
      loadMenuItems();
    }

    // ==================== CARGA INICIAL ====================
    if (localToken) {
      showDashboard();
    }

    // ==================== TOGGLE ESTADO DEL LOCAL (columna E hoja Locales) ====================
    async function loadLocalStatus() {
      const res = await fetch(`${API_URL}?action=getLocalStatus&localId=${localToken}`);
      const data = await res.json();
      const activo = data.activo === "Sí";
      document.getElementById('status-text').textContent = activo ? 'ACTIVO' : 'INACTIVO';
      document.getElementById('status-toggle').className = activo ? 'btn status-toggle btn-success' : 'btn status-toggle btn-danger';
    }

    document.getElementById('status-toggle')?.addEventListener('click', async () => {
      const current = document.getElementById('status-text').textContent;
      const nuevo = current === 'ACTIVO' ? 'No' : 'Sí';
      await fetch(`${API_URL}?action=updateLocalStatus&localId=${localToken}&status=${nuevo}`);
      loadLocalStatus();
    });

    // ==================== CARGAR ITEMS DEL MENÚ ====================
    async function loadMenuItems() {
      const res = await fetch(`${API_URL}?action=getMenu&localId=${localToken}`);
      const items = await res.json();

      const container = document.getElementById('menu-items-container');
      container.innerHTML = '';

      if (!items || items.length === 0) {
        container.innerHTML = '<p class="text-muted">Aún no tienes ítems en el menú.</p>';
        return;
      }

      // Agrupar por categoría
      const categorias = {};
      items.forEach(item => {
        const cat = item.categoria || 'Sin categoría';
        if (!categorias[cat]) categorias[cat] = [];
        categorias[cat].push(item);
      });

      Object.keys(categorias).sort().forEach(cat => {
        const section = document.createElement('div');
        section.className = 'category-section';
        section.innerHTML = `<h3 class="border-bottom pb-2">${cat}</h3><div class="row"></div>`;
        const row = section.querySelector('.row');

        categorias[cat].forEach(item => {
          const disponible = item.disponibilidad === 'Sí';
          const card = `
            <div class="col-md-4 mb-4">
              <div class="card h-100">
                ${item.imagen_url ? `<img src="${item.imagen_url}" class="card-img-top" alt="${item.nombre}">` : ''}
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title">${item.nombre}</h5>
                  <p class="card-text"><strong>$${item.precio}</strong></p>
                  <div class="mt-auto">
                    <button class="btn ${disponible ? 'btn-success' : 'btn-secondary'} btn-sm me-2" onclick="toggleItemDisponible('${item.id}', ${!disponible})">
                      ${disponible ? 'Disponible' : 'No disponible'}
                    </button>
                    <button class="btn btn-warning btn-sm me-2" onclick="editItem('${item.id}')">Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem('${item.id}')">Eliminar</button>
                  </div>
                </div>
              </div>
            </div>`;
          row.innerHTML += card;
        });

        container.appendChild(section);
      });
    }

    // ==================== TOGGLE DISPONIBILIDAD ITEM ====================
    window.toggleItemDisponible = async (id, hacerDisponible) => {
      await fetch(`${API_URL}?action=toggleItemDisponible&itemId=${id}&disponible=${hacerDisponible ? 'Sí' : 'No'}`);
      loadMenuItems();
    };

    // ==================== ELIMINAR ITEM ====================
    window.deleteItem = async (id) => {
      if (confirm('¿Seguro que quieres eliminar este ítem?')) {
        await fetch(`${API_URL}?action=deleteItem&itemId=${id}`);
        loadMenuItems();
      }
    };

    // ==================== EDITAR ITEM (placeholder) ====================
    window.editItem = (id) => {
      alert('Función editar pendiente - ID: ' + id);
    };

    // ==================== PESTAÑAS ====================
    document.getElementById('tab-mimenu').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('mimenu-content').classList.remove('d-none');
      document.getElementById('menu-form').classList.add('d-none');
      document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
      loadMenuItems();
    });

    document.getElementById('tab-agregar').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('mimenu-content').classList.add('d-none');
      document.getElementById('menu-form').classList.remove('d-none');
      document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
    });

    // ==================== CERRAR SESIÓN ====================
    document.getElementById('logout')?.addEventListener('click', () => {
      localStorage.removeItem('localToken');
      location.reload();
    });

    // ==================== TODAS LAS FUNCIONES ORIGINALES (sin cambios) ====================
    // Mostrar/ocultar formularios
    document.getElementById('show-register').addEventListener('click', () => {
      document.getElementById('local-register-form').classList.toggle('d-none');
      document.getElementById('local-login-form').classList.add('d-none');
    });
    document.getElementById('show-login').addEventListener('click', () => {
      document.getElementById('local-login-form').classList.toggle('d-none');
      document.getElementById('local-register-form').classList.add('d-none');
    });

    // REGISTRO LOCAL
    document.getElementById('local-register-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nombre = document.getElementById('reg-local-name').value.trim();
      const email = document.getElementById('reg-local-email').value.trim();
      const password = document.getElementById('reg-local-password').value;
      if (!nombre || !email || !password) {
        document.getElementById('auth-status').innerHTML = '<div class="alert alert-warning">Completa todos los campos</div>';
        return;
      }
      const url = `${API_URL}?action=registerLocal&nombre=${encodeURIComponent(nombre)}&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`;
      try {
        await fetch(url, { method: 'GET', mode: 'no-cors', cache: 'no-cache' });
        document.getElementById('auth-status').innerHTML = '<div class="alert alert-success">¡Local registrado con éxito! Ya puedes iniciar sesión.</div>';
        document.getElementById('local-register-form').reset();
        document.getElementById('local-register-form').classList.add('d-none');
        document.getElementById('local-login-form').classList.remove('d-none');
      } catch (err) {
        document.getElementById('auth-status').innerHTML = '<div class="alert alert-danger">Error de conexión. Inténtalo de nuevo.</div>';
      }
    });

    // LOGIN LOCAL (con JSONP)
    document.getElementById('local-login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-local-email').value.trim();
      const password = document.getElementById('login-local-password').value;
      if (!email || !password) {
        document.getElementById('auth-status').innerHTML = '<div class="alert alert-warning">Completa email y contraseña</div>';
        return;
      }
      const url = `${API_URL}?action=loginLocal&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}&callback=loginCallback`;
      window.loginCallback = function(data) {
        if (data.success && data.localId) {
          localStorage.setItem('localToken', data.localId);
          document.getElementById('auth-status').innerHTML = '<div class="alert alert-success">¡Login exitoso!</div>';
          setTimeout(() => location.reload(), 800);
        } else {
          document.getElementById('auth-status').innerHTML = '<div class="alert alert-danger">Email o contraseña incorrectos</div>';
        }
        delete window.loginCallback;
        const oldScript = document.getElementById('loginScript');
        if (oldScript) oldScript.remove();
      };
      const script = document.createElement('script');
      script.id = 'loginScript';
      script.src = url;
      script.onerror = () => {
        document.getElementById('auth-status').innerHTML = '<div class="alert alert-danger">Error de conexión</div>';
      };
      document.head.appendChild(script);
    });

    // AGREGAR ÍTEM AL MENÚ
    document.getElementById('menu-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!localToken) { alert('Error: No estás logueado como local'); return; }

      const fileInput = document.getElementById('foto');
      const file = fileInput.files[0];
      let imagenUrl = '';

      if (file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        document.getElementById('status').innerHTML = '<div class="alert alert-info">Subiendo imagen...</div>';
        try {
          const uploadRes = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
          const uploadData = await uploadRes.json();
          if (uploadData.secure_url) imagenUrl = uploadData.secure_url;
          else throw new Error('No se recibió URL de imagen');
        } catch (err) {
          document.getElementById('status').innerHTML = `<div class="alert alert-danger">Error subiendo imagen: ${err.message}</div>`;
          return;
        }
      }

      const menuData = {
        localId: localToken,
        nombre: document.getElementById('nombre').value,
        categoria: document.getElementById('categoria').value,
        descripcion: document.getElementById('descripcion').value,
        precio: parseFloat(document.getElementById('precio').value),
        disponibilidad: document.getElementById('disponibilidad').value,
        tamano_porcion: document.getElementById('tamano_porcion').value,
        variantes: document.getElementById('variantes').value,
        tiempo_preparacion: parseInt(document.getElementById('tiempo_preparacion').value),
        imagen_url: imagenUrl
      };

      try {
        const response = await fetch(`${API_URL}?action=addMenuItem`, {
          method: 'POST',
          body: JSON.stringify(menuData),
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors'
        });
        const result = await response.json();
        if (result.success) {
          document.getElementById('status').innerHTML = `<div class="alert alert-success">¡Ítem agregado exitosamente!</div>`;
          document.getElementById('menu-form').reset();
          fileInput.value = '';
          loadMenuItems(); // refrescar lista
        } else {
          document.getElementById('status').innerHTML = `<div class="alert alert-danger">Error al guardar: ${result.error || 'Desconocido'}</div>`;
        }
      } catch (err) {
        document.getElementById('status').innerHTML = `<div class="alert alert-danger">Error de conexión: ${err.message}</div>`;
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
